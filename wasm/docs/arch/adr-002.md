# ADR 002: Custom collections for primitive types

## Context

The Java runtime performs type erasure for generic types.
This implies that collection types like `ArrayLists` can only have boxed element types.
The primitive `int` type is boxed into `Integer` for example.

This can have negative effects on the performance of accessing these collections. 
The boxed types are scattered all over the heap and every access to a generic collection results in a random memory access.
This is bad in terms of performance, since CPU caches are optimized for reading contiguous chunks of memory.

GraalWasm requires dynamically growing collections at parse time, since the number of needed elements is often not known up front.
Furthermore these collections need to be transformed into primitive arrays before accessing them at run time to get optimal cache performance.
In addition, Truffle allows to specify arrays as `@CompilationFinal`.
This tells the compiler that the content of an array is constant in compiled code.
Generic collections do not support this behavior.

The GraalWasm bytecode only contains primitive integer-like values.
These values are extracted during parse time.

## Decision

We will implement custom collections for the primitive types `boolean`, `byte`,  `int`, and `long`. In addition, we will implement a custom collection for two-dimensional `int` arrays. The collections will use primitive arrays internally and will be easy to transform into primitive arrays of fixed size.

## Status

Active

## Consequences

During parsing the custom collections can be used to build up primitive arrays.
These primitive arrays can be easily copied to be used during run time.

Since the custom collections are not part of the standard library, they have to be maintained in GraalWasm.

## Commit

`179a300ef29`

## Artifacts

- [org.graalvm.wasm.collection.BooleanArrayList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/collection/BooleanArrayList.java)
- [org.graalvm.wasm.collection.ByteArrayList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/collection/ByteArrayList.java)
- [org.graalvm.wasm.collection.IntArrayArrayList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/collection/IntArrayArrayList.java)
- [org.graalvm.wasm.collection.IntArrayList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/collection/IntArrayList.java)
- [org.graalvm.wasm.collection.LongArrayList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/collection/LongArrayList.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.ExecutionState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/ExecutionState.java)
- [org.graalvm.wasm.SymbolTable](../../src/org.graalvm.wasm/src/org/graalvm/wasm/SymbolTable.java)
- [org.graalvm.wasm.WasmModule](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmModule.java)

## Relations

- is enabled by [ADR 001](./adr-001.md)