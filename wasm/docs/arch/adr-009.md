## ADR 009: Restructuring of the bytecode interpreter

## Context

GraalWasm was originally designed as a hybrid model using both an AST for control flow and a bytecode interpreter loop for executing instruction sequences.
Especially the bytecode interpreter loop was designed as a loop with a large switch statement inside of it.
Every WebAssembly instruction is represented by a case label and its logic is directly implemented at the case label without any function calls.
This leads to a single, large interpreter method.

The JVM defines a limit of 64k for the maximum size of a method in the bytecode.
If this limit is exceeded, the JVM refuses to compile the method.

The guest language interpreter of a Truffle language is usually also compiled by the Graal compiler when run on the JVM to improve interpreter speed. 
However, the current implementation of the GraalWasm interpreter is too large to be compiled on the JVM and the JVM refuses to compile it.

## Decision

We will restructure the bytecode interpreter so that most of the logic of individual instructions is put into separate methods.
We will keep the logic for control flow like loops, ifs, and branches in the main interpreter method to achieve good interpreter speed.

## Status

Active

## Consequences

This allows the interpreter to be compiled on the JVM. 
In addition, this makes the GraalWasm interpreter easier to understand and maintain.

## Commit

`d530ac1fedc`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)

## Relations

- extends [ADR 003](./adr-003.md)
- is related to [ADR 007](./adr-007.md)
- is related to [ADR 016](./adr-016.md)
- is related to [ADR 020](./adr-020.md)
- is related to [ADR 022](./adr-022.md)