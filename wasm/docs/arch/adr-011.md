# ADR 011: Byte array based wasm memory

## Context

GraalWasm was originally designed with a single memory implementation.
This memory implementation is based on Java `Unsafe`.
While due to its performance it represented itself as the optimal solution at the time, it poses some major security risk.

Unsafe operations can lead to segmentation faults and therefore to crashes of the JVM.
No bounds checks are performed and the allocated memory has to be managed by the implementer.
Therefore, guest language implementation should never use `Unsafe` in any of their implementations.
Since GraalWasm started as an experimental engine, this was not a big concern until now.

The current WebAssembly specification defines the maximum size of a memory as 2^32.
In addition, it defines that implementations can specify a lower limit.
Therefore, it would be possible to have a memory implementation in GraalWasm based on an array.

## Decision

We will implement a memory implementation based on a byte array.
Bytes are the smallest addressable memory in WebAssembly.

## Status

Active

## Consequences

Access to arrays automatically perform bounds checks.
The resulting exceptions can be caught and will therefore not lead to JVM crashes.

The byte array based memory might be faster in compiled code, since accesses to arrays can be optimized more easily than native memory accesses.

The `Unsafe` memory will be kept for backwards compatibility.
Therefore, a common interface for memories has to be defined.
This leads to virtual dispatches when used and can lead to performance regressions in the interpreter.

## Commit

`d88f662bb30`

## Artifacts

- [org.graalvm.wasm.api.Memory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/api/Memory.java)
- [org.graalvm.wasm.api.MemoryArrayBuffer](../../src/org.graalvm.wasm/src/org/graalvm/wasm/api/MemoryArrayBuffer.java)
- [org.graalvm.wasm.api.MemoryDescriptor](../../src/org.graalvm.wasm/src/org/graalvm/wasm/api/MemoryDescriptor.java)
- [org.graalvm.wasm.memory.ByteArrayWasmMemory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/ByteArrayWasmMemory.java)
- [org.graalvm.wasm.memory.UnsafeWasmMemory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/UnsafeWasmMemory.java)
- [org.graalvm.wasm.memory.WasmMemory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/WasmMemory.java)
- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.Linker](../../src/org.graalvm.wasm/src/org/graalvm/wasm/Linker.java)
- [org.graalvm.wasm.MemoryRegistry](../../src/org.graalvm.wasm/src/org/graalvm/wasm/MemoryRegistry.java)
- [org.graalvm.wasm.SymbolTable](../../src/org.graalvm.wasm/src/org/graalvm/wasm/SymbolTable.java)

## Relations

- is related to [ADR 015](./adr-015.md)
- is related to [ADR 021](./adr-021.md)