# ADR 010: Long array for operand stack and locals

## Context

Truffle provides a `Frame` interface for storing local variables of a guest language (in our case GraalWasm).
Furthermore, the `Frame` performs dynamic type checks when accessing its values.

GraalWasm currently uses the `Frame` to represent its operand stack and local variables.
Nearly every instruction in WebAssembly uses the operand stack.
The types of the operand stack values and local variables are statically known which means that the type checks performed in the `Frame` are redundant in GraalWasm.

Due to the complexity of the type checks, accessing the operand stack in some cases is not inlined when the interpreter gets compiled.
This has the consequences that operand stack accesses might be behind a function call which is pretty bad for the performance of the GraalWasm interpreter.

## Decision

We will move to a long array for the operand stack and local variables.

## Status

Deprecated

## Consequences

This change simplifies the access to the operand stack. 
This in turn increases the performance of the interpreter due to additional inlining.
Since escape analysis is equally applied to the `Frame` and a custom long array, the performance of compiled code is not affected.

However, the long array needs to be stored in the `Frame` when using loop nodes since the loop node can only read values that are in the `Frame`.

## Commit

`c984fcf0e7a`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.nodes.WasmIfNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmIfNode.java)
- [org.graalvm.wasm.nodes.WasmNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmNode.java)
- [org.graalvm.wasm.nodes.WasmNodeInterface](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmNodeInterface.java)
- [org.graalvm.wasm.nodes.WasmRootNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmRootNode.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.WasmCodeEntry](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmCodeEntry.java)

## Relations

- deprecates [ADR 004](./adr-004.md)
- is deprecated by [ADR 014](./adr-014.md)
- is related to [ADR 018](./adr-018.md)
- is related to [ADR 026](./adr-026.md)