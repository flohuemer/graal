# ADR 023: Fixed length encoding for custom runtime bytecode

## Context

WebAssembly uses the LEB-128 variable length value encoding to present it constant values. 
This is mainly to minimize the bytecode size of WebAssembly applications.

However, this results in a trade-off between memory usage and interpreter speed in GraalWasm.
Reading these values requires a loop.
This loop reads the most significant bit of every byte and based on this bit decides if the next byte belongs to the same value or not.

This creates a data dependency between every read byte and is therefore inefficient in terms or reading the value in the interpreter.
The value is considered constant in compiled code.
Therefore, peak performance is not effected.

Values with fixed size however can be read more effectively in the interpreter since it is known upfront how many bytes belong to the same value.

## Decision

We will used fixed length encoding for the constants in our custom runtime bytecode.

## Status

Active

## Consequences

This should increase the speed of the GraalWasm interpreter.
However, to reduce the memory overhead, two versions of every bytecode should exist for frequently used opcodes such as i32_const or i32_load. A version for small constants and a version for large constants.

This makes the generation of opcodes a little bit more involving, since a differentiation between small and large constants has to be made.

In addition, this increases the testing effort, since both versions of all opcodes must be tested.

## Commit

`0db11c724b8`

## Artifacts

- [org.graalvm.wasm.constants.Bytecode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/Bytecode.java)
- [org.graalvm.wasm.nodes.WasmFunctionNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmFunctionNode.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeGen](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeGen.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeParser.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.BinaryStreamParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryStreamParser.java)

## Relations

- is related to [ADR 022](./adr-022.md)
- is related to [ADR 024](./adr-024.md)