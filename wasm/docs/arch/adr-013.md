# ADR 013: Simplification of the control flow encoding

## Context

WebAssembly does not allows jumps to arbitrary locations and uses structure control flow. 
Every function uses a tree-like scope structure.
Every scope can be targeted with conditional and unconditional branch instructions.
In GraalWasm every scope is represented by its own node in the AST.

The main interpreter loop in GraalWasm uses its return value to indicate a potential branch to an outer scope.
If a branch instruction is encountered the current nesting depth in relation to the target scope is returned.
Every node checks if the return value is 0.
If it is 0, the node continues execution.
If it is not 0, the node decrease the value by one and propagates it to its parent node.

Currently, Truffle only supported object return values in nodes.
Therefore, this nesting depth value was wrapped in a `TargetOffset` object.
The `TargetOffset` objects were cached to get better performance.
However, these cached values can not be optimized by the partial evaluator.
This means that in compiled code every branch performs a lookup in an array and performs a bounds check.

## Decision

We will implement the nesting depth via a boxed integer value instead.

## Status

Deprecated

## Consequences

In Java most small integer values below 256 are cached by the runtime.
This makes accessing them efficient.
In addition, the partial evaluator can optimize branches using integer values to get better performance in compiled code.
Furthermore, this reduces the memory needed for the cached values.

## Commit

`5447964ff1e`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.nodes.WasmIfNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmIfNode.java)
- [org.graalvm.wasm.nodes.WasmNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmNode.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)

## Relations

- extends [ADR 003](./adr-003.md)
- deprecated by [ADR 016](./adr-016.md)