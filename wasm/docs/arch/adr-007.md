# ADR 007: br_table implementation via a loop

## Context

WebAssembly provides a br_table instruction to dynamically select a branch target at runtime.
This instruction uses a static list of branch targets.
At runtime a index into the list is provided based on which the actual branch target is selected.

The Truffle framework allows to use the `CompilerDirectives.inInterpreter` and `CompilerDirectives.inCompiledCode` instructions to write different code for the interpreter and compiled code.
During partial evaluation the corresponding branch is constant folded which results in no performance penalty.

The compiler uses a special `IntegerSwitchNode` for branches with several possible locations.
The usage of this `IntegerSwitchNode` is inferred by Truffle during partial evaluation.

Selecting a single branch in the interpreter will not generate an `IntegerSwitchNode` in the compiler but instead will lead to a dynamic memory read.

## Decision

We will implement the br_table instruction via a loop such that a `IntegerSwitchNode` is generated.
We will split the br_table implementation into a compiler specific and an interpreter specific implementation to reach the best performance in both cases.
We will still use a array lookup in the interpreter case.

## Status

Active

## Consequences

The performance of compiled code is better due to the use of an `IntegerSwitchNode`.
However, the implementation might be hard to understand and must be well documented.
Furthermore, having two different implementations for compiler and interpreter increases the code size.

## Commit

`983b46fe3d8`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)

## Relations

- is enabled by [ADR 003](./adr-003.md)
- is related to [ADR 009](./adr-009.md)
- is related to [ADR 016](./adr-016.md)
- is related to [ADR 020](./adr-020.md)
- is related to [ADR 022](./adr-022.md)