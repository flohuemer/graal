# ADR 012: Removal of constant decoding

## Context

Constants are encoded as LEB-128 values in WebAssembly.
This format uses the first bit of every byte as an indicator value.
If the first bit is 1, an additional byte belonging to the same value follows.
If the first bit is 0, the current byte is the last byte of the value.

Currently, these constants are decoded during parsing and stored in int and long arrays.
This makes accessing them in the interpreter faster but introduces additional memory overhead.

We identified that the access to to the individual int and long arrays is actually slower than decoding the values in the interpreter.
This can be mainly attributed to cache locality.
Reading data from a continues memory region is profitable in terms of cache locality.

## Decision

We will now longer store constants in separate arrays, but decode them in the interpreter

## Status

Deprecated

## Consequences

This reduces the memory footprint of GraalWasm.
Furthermore, the interpreter performance and the peak performance are stable.
In addition, this simplifies the access to the constants since the implementation can be shared between the interpreter and the parser.

## Commit

`63b9e4b5a87`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.nodes.WasmRootNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmRootNode.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.BinaryStreamParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryStreamParser.java)
- [org.graalvm.wasm.ExecutionState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/ExecutionState.java)

## Relations

- deprecates [ADR 005](./adr-005.md)
- is related to [ADR 016](./adr-016.md)
- is deprecated by [ADR 022](./adr-022.md)