# ADR 016: Flat bytecode interpreter model

## Context

WebAssembly uses structure control flow instead of jumps to arbitrary locations.
Every function uses a tree-like scope structure.
Every scope can be targeted with conditional or unconditional branch instructions.

Currently, control flow in GraalWasm is represented by several AST nodes.
There is one node for every block, if, and loop.
The body of every function and loop is an additional block node.
In addition, the then and else branch of every if is also represented by a block node.
This represents a significant memory overhead compares to the single digit number of bytes these instructions take up in the WebAssembly bytecode.

In addition, control flow is represented by a cascade of return statements.
Every branch instruction results in a return of the main interpreter loop in one of the block nodes.
The return value is the relative nesting depth in relation to the target scope.
Every parent node checks if the return value of its child not is 0.
If it is 0, the parent node continues execution.
If it is not 0, the node decreases the value by one and propagates it to its parent node.

This results in a lot of overhead in the interpreter due to additional function calls.
In addition, this control flow representation quickly drowns the inlining budget.
Furthermore, the additional memory overhead for every control flow node adds up.

## Decision

We will reimplement the interpreter as a flat model.
This means that control flow is represented by jumps to fixed locations in the byte array used to store the WebAssembly code.

## Status

Active

## Consequences

The interpreter performance will increase due to a reduction of function calls.
Furthermore, the peak performance will increase due to a simplification of the function graphs.
In addition, The memory usage will be reduced due to the decrease in the number of AST nodes.

The effort in the parser will increase since the jump locations must be calculated and stored.
Hence, an additional data structure is needed to store the jump locations and additionally needed information.

This model is easier comprehend than the hybrid model used previously.
However, the parser logic is now more complicated.

## Commit

`dfc56744296`

## Artifacts

- [org.graalvm.wasm.constants.ExtraDataOffsets](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/ExtraDataOffsets.java)
- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.nodes.WasmFunctionNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmFunctionNode.java)
- [org.graalvm.wasm.nodes.WasmIfNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmIfNode.java)
- [org.graalvm.wasm.nodes.WasmNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmNode.java)
- [org.graalvm.wasm.nodes.WasmRootNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmRootNode.java)
- [org.graalvm.wasm.parser.ir.BlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/ir/BlockNode.java)
- [org.graalvm.wasm.parser.ir.CodeEntry](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/ir/CodeEntry.java)
- [org.graalvm.wasm.parser.validation.BlockFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/BlockFrame.java)
- [org.graalvm.wasm.parser.validation.ControlFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/ControlFrame.java)
- [org.graalvm.wasm.parser.validation.ExtraDataList](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/ExtraDataList.java)
- [org.graalvm.wasm.parser.validation.IfFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/IfFrame.java)
- [org.graalvm.wasm.parser.validation.LoopFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/LoopFrame.java)
- [org.graalvm.wasm.parser.validation.ParserState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/ParserState.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.Linker](../../src/org.graalvm.wasm/src/org/graalvm/wasm/Linker.java)
- [org.graalvm.wasm.WasmCodeEntry](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmCodeEntry.java)
- [org.graalvm.wasm.WasmInstantiator](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmInstantiator.java)

## Relations

- deprecates [ADR 003](./adr-003.md)
- is related to [ADR 007](./adr-007.md)
- is related to [ADR 009](./adr-009.md)
- is related to [ADR 012](./adr-012.md)
- deprecates [ADR 013](./adr-013.md)
- is related to [ADR 017](./adr-017.md)
- is extended by [ADR 022](./adr-022.md)