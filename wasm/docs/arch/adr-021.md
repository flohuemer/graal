# ADR 021: Additional native memory implementation

## Context

The WebAssembly memory64 proposal extends the addressable memory to a size of 2^64.
This allows for applications to use more than 4GB of memory.

Java arrays and `ByteBuffers` are limited to a maximum size of 2^31.
This is due to the fact that Java uses signed integers for allocating and accessing those types of collections.

However, Java provides an `Unsafe` interface to interact with native memory.
This allows to allocate more than 2GB of memory in Java.

The current version of our `Unsafe` memory uses the `ByteBuffer` for better interoperability with Graal.js.
As mentioned before, this limits its size to 2GB.

## Decision

We will implement an additional native memory implementation exclusively based on Java `Unsafe`.

## Status

Active

## Consequences

This increases the theoretical limit for memory size to 2^64.
As a consequence, we are able to implement the memory64 proposal.

However, this approach poses a security risk, since the memory has to be managed by GraalWasm. 
We must make sure that memory is always allocated and freed correctly.

This way of implementing memory is also bad for testing. 
If a part of the memory that should not be accessed is accessed in a test, the entire JVM can crash.
Therefore, we do not get a test report and the error will be hard to find.
In addition, this solution is harder to comprehend, since `Unsafe` should not and is rarely used in any Java application.

## Commit

`0db11c724b8`

## Artifacts

- [org.graalvm.wasm.memory.NativeDataInstanceUtil](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/NativeDataInstanceUtil.java)
- [org.graalvm.wasm.memory.NativeWasmMemory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/NativeWasmMemory.java)
- [org.graalvm.wasm.memory.WasmMemoryFactory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/WasmMemoryFactory.java)
- [org.graalvm.wasm.RuntimeState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/RuntimeState.java)
- [org.graalvm.wasm.test.suites.memory.Memory64Suite](../../src/org.graalvm.wasm.test/src/org/graalvm/wasm/test/suites/memory/Memory64Suite.java)

## Relations

-  is related to [ADR 011](./adr-011.md)
-  is related to [ADR 015](./adr-015.md)