# ADR 020: Custom instructions for reference types

## Context

The reference type proposal introduces two new value types to WebAssembly, function references and references to external objects.
These can be used like any other value type. 
They can be used on the operand stack, can be passed to functions, can be used as return values, and can be stored in local or global variables.
The instructions in the WebAssembly bytecode like storing and loading local variables are not extended with new instructions, but the existing instructions support the new value types.

The `Frame` used to represent the local variables and the operand stack in GraalWasm internally uses two arrays to store values.
It uses a `long` array for primitive values and an `Object` array for reference values.
Therefore, the static API of the frame provides separate methods for primitive and reference values.
For example, the copy method exists as `copyPrimitiveStatic`, to only copy values in the primitive array, `copyObjectStatic`, to only copy values in the object array, and `copyStatic` to copy the values in both arrays.
For optimal interpreter performance, the more specific methods should be used whenever possible.

## Decision

We will introduce custom instructions for loading and storing local variables that use a reference type. 
In this way we can statically differentiate between primitive values and reference values.

## Status

Deprecated

## Consequences

This will keep the interpreter performance stable, while adding support for reference types.
However, this will use some reserved values from the WebAssembly bytecode.
These values will probably be used by different instructions in the future.
Furthermore, this increases the effort in the parser and makes it harder to understand.

## Commit

`cad2ff1ee5d`

## Artifacts

- [org.graalvm.wasm.constants.Instructions](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/Instructions.java)
- [org.graalvm.wasm.nodes.WasmFunctionNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmFunctionNode.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)

## Relations

- is related to [ADR 007](./adr-007.md)
- is related to [ADR 009](./adr-009.md)
- is related to [ADR 014](./adr-014.md)
- is related to [ADR 018](./adr-018.md)
- is deprecated by [ADR 022](./adr-022.md)