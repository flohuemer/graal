# ADR 022: Custom runtime bytecode

## Context

Currently, GraalWasm uses the WebAssembly bytecode for both parsing and executing WebAssembly applications.
While this is in general a good idea, it presents some drawbacks in terms of customizability.

Especially the introduction of the reference types proposal showed that custom instructions are needed to keep the performance of existing features while being able to add new features.

The current solution for reference types uses reserved opcodes in the WebAssembly instruction set to represent custom implementations.
This cannot be used as a long-term solution, since these opcodes will be used by other WebAssembly instructions in the future.

## Decision

We will use a custom internal bytecode that is custom to GraalWasm and allows for GraalWasm specific features such as the differentiation between primitives and reference types for all affected instructions.

## Status

Active

## Consequences

This should increase interpreter performance, since we can have more GraalWasm specific opcodes.
In addition, this should decrease memory overhead, since the original WebAssembly bytecode, including all sections, does no longer have to be stored after parsing.

This makes it much easier to implement new proposals, since the custom bytecode can be changed to fit the best possible solution. This is not possible when using the WebAssembly bytecode.

However, the maintenance effort will increase, since we have to maintain instructions and parsers for both bytecode formats.

## Commit

`0db11c724b8`

## Artifacts

- [org.graalvm.wasm.constants.Bytecode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/Bytecode.java)
- [org.graalvm.wasm.constants.BytecodeBitEncoding](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/BytecodeBitEncoding.java)
- [org.graalvm.wasm.nodes.WasmFunctionNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmFunctionNode.java)
- [org.graalvm.wasm.nodes.WasmRootNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmRootNode.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeGen](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeGen.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeParser.java)
- [org.graalvm.wasm.parser.validation.collections](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/collections)
- [org.graalvm.wasm.parser.validation.BlockFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/BlockFrame.java)
- [org.graalvm.wasm.parser.validation.ControlFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/ControlFrame.java)
- [org.graalvm.wasm.parser.validation.IfFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/IfFrame.java)
- [org.graalvm.wasm.parser.validation.LoopFrame](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/LoopFrame.java)
- [org.graalvm.wasm.parser.validation.ParseState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/validation/ParserState.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.BinaryStreamParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryStreamParser.java)
- [org.graalvm.wasm.Linker](../../src/org.graalvm.wasm/src/org/graalvm/wasm/Linker.java)
- [org.graalvm.wasm.RuntimeState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/RuntimeState.java)
- [org.graalvm.wasm.test.suites.bytecode.BytecodeSuite](../../src/org.graalvm.wasm.test/src/org/graalvm/wasm/test/suites/bytecode/BytecodeSuite.java)

## Relations

- is related to [ADR 007](./adr-007.md)
- is related to [ADR 009](./adr-009.md)
- deprecates [ADR 012](./adr-012.md)
- extends [ADR 016](./adr-016.md)
- deprecates [ADR 017](./adr-017.md)
- deprecates [ADR 020](./adr-020.md)
- is related to [ADR 023](./adr-023.md)
- enables [ADR 024](./adr-024.md)