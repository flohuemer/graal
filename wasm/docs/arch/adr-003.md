# ADR 003: Hybrid interpreter model (AST | bytecode interpreter loop)

## Context

WebAssembly is a bytecode format with structured control flow.
Instead of using jumps to arbitrary locations in the bytecode, WebAssembly uses scopes defined by blocks, ifs, and loops instructions.
Every scope is closed by an end instruction.
Scopes can be nested into on another and can be targeted by conditional and unconditional branch instructions.

WebAssembly functions are represented by sequences of instructions.
The instructions are executed one after the other and manipulate an operand stack.

The Truffle framework requires guest languages (like GraalWasm) to represent their source code as an abstract syntax tree (AST) for it to be partially evaluated and compiled by Truffle.
Structured control flow can be efficiently represented by an AST.

Bytecode based languages often use a bytecode interpreter loop for the implementation of an interpreter.
In comparison to an AST this improves the memory footprint since the bytecode only needs to be stored in an array and no AST nodes have to be generated.
In addition, this improves the cache-locality of the source code representation.

## Decision

We will implement the GraalWasm interpreter as a hybrid model between an AST and a bytecode interpreter loop. 
Control flow like blocks, ifs, and loops will be implemented as AST nodes while the instruction sequences inside of them will be executed in a bytecode interpreter loop.

## Status

Deprecated

## Consequences

The result of using a hybrid model is that the memory footprint of this implementation is much lower than representing every single instruction by a separate node.
In addition, optimizations for loops and conditionals provided by the Truffle framework can still be used due to control flow being represented by an AST.

This architecture still has some memory overhead since the control flow nodes have to potentially store some additional information.
This model might be harder to comprehend and test due to the mixture of AST and bytecode interpreter.

## Commit

`179a300ef29`

## Artifacts

- [org.graalvm.wasm.nodes.WasmBlockNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmBlockNode.java)
- [org.graalvm.wasm.nodes.WasmIfNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmIfNode.java)
- [org.graalvm.wasm.nodes.WasmNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmNode.java)
- [org.graalvm.wasm.nodes.WasmRootNode](../../src/org.graalvm.wasm/src/org/graalvm/wasm/nodes/WasmRootNode.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)

## Relations

- is enabled by [ADR 001](./adr-001.md)
- enables [ADR 007](./adr-007.md)
- is extended by [ADR 009](./adr-009.md)
- is extended by [ADR 013](./adr-013.md)
- is deprecated by [ADR 016](./adr-016.md)