# ADR 015: ByteBuffer in UnsafeWasmMemory

## Context

Currently, the `UnsafeWasmMemory` uses Java `Unsafe` to allocate and handle memory.
Graal.js uses the Java `ByteBuffer` class as a common interface for all its memory implementation.
This `ByteBuffer` is also passed to native code by Graal.js.
This is necessary since Graal.js supports Node.js.
Node.js uses a lot of native code to interact with its JavaScript engine. 
Since Graal.js replaces V8 in this Node.js implementation, native code is needed to forward calls between Node.js and Graal.js

Currently, passing a WebAssembly memory via Graal.js to Node.js is slow, since the native code does not support the pointers in the `UnsafeWasmMemory`.

## Decision

We will reimplement the `UnsafeWasmMemory` based on a `ByteBuffer`.

## Status

Active

## Consequences

The `ByteBuffer` can still be accessed via `Unsafe`.
Therefore, performance should not be affected.
This allows Graal.js to use the memory directly without any conversions.

## Commit

`b0b69881b51`

## Artifacts

- [org.graalvm.wasm.api.WebAssembly](../../src/org.graalvm.wasm/src/org/graalvm/wasm/api/WebAssembly.java)
- [org.graalvm.wasm.memory.UnsafeWasmMemory](../../src/org.graalvm.wasm/src/org/graalvm/wasm/memory/UnsafeWasmMemory.java)

## Relations

- is related to [ADR 006](./adr-006.md)
- is related to [ADR 011](./adr-011.md)
- is related to [ADR 021](./adr-021.md)