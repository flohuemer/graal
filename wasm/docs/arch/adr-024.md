# ADR 024: Serialization of linker data after first linking

## Context

Linking in GraalWasm requires the source bytecode to be transformed into an internal representation in the form of link actions.
In addition, linking requires the call targets of all functions to link them to their corresponding call sites.
Furthermore, the initial data of the memory and tables needs to be extracted to be set after linking.

Currently, this data is kept in this intermediate representation after linking is finished, so we can potentially relink a module a second time. 
This is possible if the initialization process is triggered from JavaScript.
Here, the same module can be initialized several times.

However, linking the same module several times is very unlikely.
Therefore, the data needed for linking could be stored in a different, more compact representation.

## Decision

We will store linking data in the custom runtime bytecode after the first linking has happened.

## Status

Active

## Consequences

This reduces the memory overhead of the data needed for linking.
Furthermore, since the data is stored in a `byte` array instead of Java objects, we can reduce the data needed for object headers and class objects.
In addition, this allows us to store values in variable representation instead of fixed sizes.
This further reduces the memory overhead.

However, this representation might be harder to comprehend, since the data is serialized into a `byte` array and not kept in class structures.

It is also harder to learn, since the layout of the data has to be extracted from static constant values instead of field of classes.

## Commit

`0db11c724b8`

## Artifacts

- [org.graalvm.wasm.constants.BytecodeBitEncoding](../../src/org.graalvm.wasm/src/org/graalvm/wasm/constants/BytecodeBitEncoding.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeGen](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeGen.java)
- [org.graalvm.wasm.parser.bytecode.BytecodeParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/parser/bytecode/BytecodeParser.java)
- [org.graalvm.wasm.BinaryParser](../../src/org.graalvm.wasm/src/org/graalvm/wasm/BinaryParser.java)
- [org.graalvm.wasm.Linker](../../src/org.graalvm.wasm/src/org/graalvm/wasm/Linker.java)
- [org.graalvm.wasm.RuntimeState](../../src/org.graalvm.wasm/src/org/graalvm/wasm/RuntimeState.java)
- [org.graalvm.wasm.WasmInstantiator](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmInstantiator.java)
- [org.graalvm.wasm.WasmModule](../../src/org.graalvm.wasm/src/org/graalvm/wasm/WasmModule.java)
- [org.graalvm.wasm.test.suites.bytecode.MultiInstantiationSuite](../../src/org.graalvm.wasm.test/src/org/graalvm/wasm/test/suites/bytecode/MultiInstantiationSuite.java)

## Relations

- is related to [ADR 008](./adr-008.md)
- is enabled by [ADR 022](./adr-022.md)
- is related to [ADR 023](./adr-023.md)